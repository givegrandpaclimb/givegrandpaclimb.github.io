const n=new Set([!0,!1,"alt","title"]);function i(n,i){return(Array.isArray(n)?n:[]).filter(([n])=>n!==i)}function e(n,e){n&&n.attrs&&(n.attrs=i(n.attrs,e))}function t(i,t){if(!n.has(i))throw new TypeError(`figcaption must be one of: ${[...n]}.`);if("alt"===i)return t.content;const o=t.attrs.find(([n])=>"title"===n);return Array.isArray(o)&&o[1]?(e(t,"title"),o[1]):void 0}function o(n,o){o=o||{},n.core.ruler.before("linkify","image_figures",function(c){let f=1;for(let r=1,a=c.tokens.length;r<a-1;++r){const s=c.tokens[r];if("inline"!==s.type)continue;if(!s.children||1!==s.children.length&&3!==s.children.length)continue;if(1===s.children.length&&"image"!==s.children[0].type)continue;if(3===s.children.length){const[n,i,e]=s.children;if("link_open"!==n.type||"image"!==i.type||"link_close"!==e.type)continue}if(0!==r&&"paragraph_open"!==c.tokens[r-1].type)continue;if(r!==a-1&&"paragraph_close"!==c.tokens[r+1].type)continue;const l=c.tokens[r-1];let g;if(l.type="figure_open",l.tag="figure",c.tokens[r+1].type="figure_close",c.tokens[r+1].tag="figure",o.dataType&&c.tokens[r-1].attrPush(["data-type","image"]),o.link&&1===s.children.length){[g]=s.children;const n=new c.Token("link_open","a",1);n.attrPush(["href",g.attrGet("src")]),s.children.unshift(n),s.children.push(new c.Token("link_close","a",-1))}if(g=1===s.children.length?s.children[0]:s.children[1],o.figcaption){const e=t(o.figcaption,g);if(e){const[t]=n.parseInline(e,c.env);s.children.push(new c.Token("figcaption_open","figcaption",1)),s.children.push(...t.children),s.children.push(new c.Token("figcaption_close","figcaption",-1)),g.attrs&&(g.attrs=i(g.attrs,"title"))}}if(o.copyAttrs&&g.attrs){const n=!0===o.copyAttrs?"":o.copyAttrs;l.attrs=g.attrs.filter(([i])=>i.match(n)).map(n=>Array.from(n))}if(o.tabindex&&(c.tokens[r-1].attrPush(["tabindex",f]),f++),o.lazy&&(g.attrs.some(([n])=>"loading"===n)||g.attrs.push(["loading","lazy"])),o.async&&(g.attrs.some(([n])=>"decoding"===n)||g.attrs.push(["decoding","async"])),o.classes&&"string"==typeof o.classes){let n=!1;for(let i=0,e=g.attrs.length;i<e&&!n;i++){const e=g.attrs[i];"class"===e[0]&&(e[1]=`${e[1]} ${o.classes}`,n=!0)}n||g.attrs.push(["class",o.classes])}if(o.removeSrc){const n=g.attrs.find(([n])=>"src"===n);g.attrs.push(["data-src",n[1]]),e(g,"src")}}})}export{o as r};
