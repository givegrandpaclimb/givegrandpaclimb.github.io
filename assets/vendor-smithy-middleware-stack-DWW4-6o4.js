const e=(e,r)=>{const o=[];if(e&&o.push(e),r)for(const t of r)o.push(t);return o},r=(e,r)=>`${e||"anonymous"}${r&&r.length>0?` (a.k.a. ${r.join(",")})`:""}`,o=()=>{let n=[],a=[],s=!1;const l=new Set,d=e=>(n.forEach(r=>{e.add(r.middleware,{...r})}),a.forEach(r=>{e.addRelativeTo(r.middleware,{...r})}),e.identifyOnResolve?.(p.identifyOnResolve()),e),f=e=>{const r=[];return e.before.forEach(e=>{0===e.before.length&&0===e.after.length?r.push(e):r.push(...f(e))}),r.push(e),e.after.reverse().forEach(e=>{0===e.before.length&&0===e.after.length?r.push(e):r.push(...f(e))}),r},c=(o=!1)=>{const s=[],l=[],d={};var c;return n.forEach(r=>{const o={...r,before:[],after:[]};for(const t of e(o.name,o.aliases))d[t]=o;s.push(o)}),a.forEach(r=>{const o={...r,before:[],after:[]};for(const t of e(o.name,o.aliases))d[t]=o;l.push(o)}),l.forEach(e=>{if(e.toMiddleware){const t=d[e.toMiddleware];if(void 0===t){if(o)return;throw new Error(`${e.toMiddleware} is not found when adding ${r(e.name,e.aliases)} middleware ${e.relation} ${e.toMiddleware}`)}"after"===e.relation&&t.after.push(e),"before"===e.relation&&t.before.push(e)}}),(c=s,c.sort((e,r)=>t[r.step]-t[e.step]||i[r.priority||"normal"]-i[e.priority||"normal"])).map(f).reduce((e,r)=>(e.push(...r),e),[])},p={add:(o,t={})=>{const{name:i,override:a,aliases:s}=t,d={step:"initialize",priority:"normal",middleware:o,...t},f=e(i,s);if(f.length>0){if(f.some(e=>l.has(e))){if(!a)throw new Error(`Duplicate middleware name '${r(i,s)}'`);for(const e of f){const o=n.findIndex(r=>r.name===e||r.aliases?.some(r=>r===e));if(-1===o)continue;const t=n[o];if(t.step!==d.step||d.priority!==t.priority)throw new Error(`"${r(t.name,t.aliases)}" middleware with ${t.priority} priority in ${t.step} step cannot be overridden by "${r(i,s)}" middleware with ${d.priority} priority in ${d.step} step.`);n.splice(o,1)}}for(const e of f)l.add(e)}n.push(d)},addRelativeTo:(o,t)=>{const{name:i,override:n,aliases:s}=t,d={middleware:o,...t},f=e(i,s);if(f.length>0){if(f.some(e=>l.has(e))){if(!n)throw new Error(`Duplicate middleware name '${r(i,s)}'`);for(const e of f){const o=a.findIndex(r=>r.name===e||r.aliases?.some(r=>r===e));if(-1===o)continue;const t=a[o];if(t.toMiddleware!==d.toMiddleware||t.relation!==d.relation)throw new Error(`"${r(t.name,t.aliases)}" middleware ${t.relation} "${t.toMiddleware}" middleware cannot be overridden by "${r(i,s)}" middleware ${d.relation} "${d.toMiddleware}" middleware.`);a.splice(o,1)}}for(const e of f)l.add(e)}a.push(d)},clone:()=>d(o()),use:e=>{e.applyToStack(p)},remove:r=>"string"==typeof r?(r=>{let o=!1;const t=t=>{const i=e(t.name,t.aliases);if(i.includes(r)){o=!0;for(const e of i)l.delete(e);return!1}return!0};return n=n.filter(t),a=a.filter(t),o})(r):(r=>{let o=!1;const t=t=>{if(t.middleware===r){o=!0;for(const r of e(t.name,t.aliases))l.delete(r);return!1}return!0};return n=n.filter(t),a=a.filter(t),o})(r),removeByTag:r=>{let o=!1;const t=t=>{const{tags:i,name:n,aliases:a}=t;if(i&&i.includes(r)){const r=e(n,a);for(const e of r)l.delete(e);return o=!0,!1}return!0};return n=n.filter(t),a=a.filter(t),o},concat:e=>{const r=d(o());return r.use(e),r.identifyOnResolve(s||r.identifyOnResolve()||(e.identifyOnResolve?.()??!1)),r},applyToStack:d,identify:()=>c(!0).map(e=>{const o=e.step??e.relation+" "+e.toMiddleware;return r(e.name,e.aliases)+" - "+o}),identifyOnResolve:e=>("boolean"==typeof e&&(s=e),s),resolve:(e,r)=>{for(const o of c().map(e=>e.middleware).reverse())e=o(e,r);return e}};return p},t={initialize:5,serialize:4,build:3,finalizeRequest:2,deserialize:1},i={high:3,normal:2,low:1};export{o as c};
