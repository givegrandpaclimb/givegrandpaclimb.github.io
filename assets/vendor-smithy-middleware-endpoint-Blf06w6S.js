import{t as n}from"./vendor-smithy-core-CFTV9i4d.js";import{g as t,n as e}from"./vendor-smithy-util-middleware-CiYOBhdT.js";import{s as o}from"./vendor-smithy-middleware-serde-INCYEVVd.js";import{p as r}from"./vendor-smithy-url-parser-IFsFzf0X.js";const i=/^[a-z0-9][a-z0-9\.\-]{1,61}[a-z0-9]$/,a=/(\d+\.){3}\d+/,s=/\.\./,c=(n,t,e)=>{const o=async()=>{const o=e[n]??e[t];return"function"==typeof o?o():o};return"credentialScope"===n||"CredentialScope"===t?async()=>{const n="function"==typeof e.credentials?await e.credentials():e.credentials;return n?.credentialScope??n?.CredentialScope}:"accountId"===n||"AccountId"===t?async()=>{const n="function"==typeof e.credentials?await e.credentials():e.credentials;return n?.accountId??n?.AccountId}:"endpoint"===n||"endpoint"===t?async()=>{if(!1===e.isCustomEndpoint)return;const n=await o();if(n&&"object"==typeof n){if("url"in n)return n.url.href;if("hostname"in n){const{protocol:t,hostname:e,port:o,path:r}=n;return`${t}//${e}${o?":"+o:""}${r}`}}return n}:o},d=async n=>{},p=n=>"object"==typeof n?"url"in n?r(n.url):n:r(n),u=async(n,t,e)=>{const o={},r=t?.getEndpointParameterInstructions?.()||{};for(const[i,a]of Object.entries(r))switch(a.type){case"staticContextParams":o[i]=a.value;break;case"contextParams":o[i]=n[a.name];break;case"clientContextParams":case"builtInParams":o[i]=await c(a.name,i,e)();break;case"operationContextParams":o[i]=a.get(n);break;default:throw new Error("Unrecognized endpoint parameter instruction: "+JSON.stringify(a))}return 0===Object.keys(r).length&&Object.assign(o,e),"s3"===String(e.serviceId).toLowerCase()&&await(async n=>{const t=n?.Bucket||"";if("string"==typeof n.Bucket&&(n.Bucket=t.replace(/#/g,encodeURIComponent("#")).replace(/\?/g,encodeURIComponent("?"))),(n=>{const[t,e,o,,,r]=n.split(":"),i="arn"===t&&n.split(":").length>=6,a=Boolean(i&&e&&o&&r);if(i&&!a)throw new Error(`Invalid ARN: ${n} was an invalid ARN.`);return a})(t)){if(!0===n.ForcePathStyle)throw new Error("Path-style addressing cannot be used with ARN buckets")}else e=t,(!i.test(e)||a.test(e)||s.test(e)||-1!==t.indexOf(".")&&!String(n.Endpoint).startsWith("http:")||t.toLowerCase()!==t||t.length<3)&&(n.ForcePathStyle=!0);var e;return n.DisableMultiRegionAccessPoints&&(n.disableMultiRegionAccessPoints=!0,n.DisableMRAP=!0),n})(o),o},f={step:"serialize",tags:["ENDPOINT_PARAMETERS","ENDPOINT_V2","ENDPOINT"],name:"endpointV2Middleware",override:!0,relation:"before",toMiddleware:o.name},l=(e,o)=>({applyToStack:r=>{r.addRelativeTo((({config:e,instructions:o})=>(r,i)=>async a=>{e.isCustomEndpoint&&n(i,"ENDPOINT_OVERRIDE","N");const s=await(async(n,t,e,o)=>{if(!e.isCustomEndpoint){let n;n=e.serviceConfiguredEndpoint?await e.serviceConfiguredEndpoint():await d(e.serviceId),n&&(e.endpoint=()=>Promise.resolve(p(n)),e.isCustomEndpoint=!0)}const r=await u(n,t,e);if("function"!=typeof e.endpointProvider)throw new Error("config.endpointProvider is not set.");return e.endpointProvider(r,o)})(a.input,{getEndpointParameterInstructions:()=>o},{...e},i);i.endpointV2=s,i.authSchemes=s.properties?.authSchemes;const c=i.authSchemes?.[0];if(c){i.signing_region=c.signingRegion,i.signing_service=c.signingName;const n=t(i),e=n?.selectedHttpAuthScheme?.httpAuthOption;e&&(e.signingProperties=Object.assign(e.signingProperties||{},{signing_region:c.signingRegion,signingRegion:c.signingRegion,signing_service:c.signingName,signingName:c.signingName,signingRegionSet:c.signingRegionSet},c.properties))}return r({...a})})({config:e,instructions:o}),f)}}),m=n=>{const t=n.tls??!0,{endpoint:o,useDualstackEndpoint:r,useFipsEndpoint:i}=n,a=null!=o?async()=>p(await e(o)()):void 0,s=!!o,c=Object.assign(n,{endpoint:a,tls:t,isCustomEndpoint:s,useDualstackEndpoint:e(r??!1),useFipsEndpoint:e(i??!1)});let u;return c.serviceConfiguredEndpoint=async()=>(n.serviceId&&!u&&(u=d(n.serviceId)),u),c};export{m as a,l as g,u as r};
