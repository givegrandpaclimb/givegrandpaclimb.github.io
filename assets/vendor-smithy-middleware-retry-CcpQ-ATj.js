import{R as e,A as t,S as r,a,I as s,b as o}from"./vendor-smithy-util-retry-Xgw0yZC_.js";import{n}from"./vendor-smithy-util-middleware-I6Z6a_gz.js";import{i,a as m,b as y}from"./vendor-smithy-service-error-classification-IwpPNb5_.js";import{a as c,H as d}from"./vendor-smithy-protocol-http-ZjGpQTbx.js";import{v as p}from"./vendor-smithy-uuid-CiJeYpB1.js";import{N as u}from"./vendor-smithy-smithy-client-WTndHW9r.js";const f=e=>e instanceof Error?e:e instanceof Object?Object.assign(new Error,e):"string"==typeof e?new Error(e):new Error(`AWS SDK error wrapper for ${e}`),R=s=>{const{retryStrategy:o,retryMode:i,maxAttempts:m}=s,y=n(m??a);return Object.assign(s,{maxAttempts:y,retryStrategy:async()=>o||(await n(i)()===e.ADAPTIVE?new t(y):new r(y))})},w=e=>e?.body instanceof ReadableStream,l=e=>{const t={error:e,errorType:h(e)},r=E(e.$response);return r&&(t.retryAfterHint=r),t},h=e=>i(e)?"THROTTLING":m(e)?"TRANSIENT":y(e)?"SERVER_ERROR":"CLIENT_ERROR",g={name:"retryMiddleware",tags:["RETRY"],step:"finalizeRequest",priority:"high",override:!0},T=e=>({applyToStack:t=>{t.add((e=>(t,r)=>async a=>{let n=await e.retryStrategy();const i=await e.maxAttempts();if(!(e=>void 0!==e.acquireInitialRetryToken&&void 0!==e.refreshRetryTokenForRetry&&void 0!==e.recordSuccess)(n))return n?.mode&&(r.userAgent=[...r.userAgent||[],["cfg/retry-mode",n.mode]]),n.retry(t,a);{let e=await n.acquireInitialRetryToken(r.partition_id),d=new Error,R=0,h=0;const{request:g}=a,T=c.isInstance(g);for(T&&(g.headers[s]=p());;)try{T&&(g.headers[o]=`attempt=${R+1}; max=${i}`);const{response:r,output:s}=await t(a);return n.recordSuccess(e),s.$metadata.attempts=R+1,s.$metadata.totalRetryDelay=h,{response:r,output:s}}catch(m){const t=l(m);if(d=f(m),T&&w(g))throw(r.logger instanceof u?console:r.logger)?.warn("An error was encountered in a non-retryable streaming request."),d;try{e=await n.refreshRetryTokenForRetry(e,t)}catch(y){throw d.$metadata||(d.$metadata={}),d.$metadata.attempts=R+1,d.$metadata.totalRetryDelay=h,d}R=e.getRetryCount();const a=e.getRetryDelay();h+=a,await new Promise(e=>setTimeout(e,a))}}})(e),g)}}),E=e=>{if(!d.isInstance(e))return;const t=Object.keys(e.headers).find(e=>"retry-after"===e.toLowerCase());if(!t)return;const r=e.headers[t],a=Number(r);return Number.isNaN(a)?new Date(r):new Date(1e3*a)};export{T as g,R as r};
