import{s as e}from"./vendor-smithy-core-BjtElWb2.js";import{g as n,n as t}from"./vendor-smithy-util-middleware-I6Z6a_gz.js";import{s as i}from"./vendor-smithy-middleware-serde-uGqvsUM0.js";import{p as s}from"./vendor-smithy-url-parser-Bxshk8Zo.js";const o=/^[a-z0-9][a-z0-9\.\-]{1,61}[a-z0-9]$/,r=/(\d+\.){3}\d+/,a=/\.\./,c=(e,n,t)=>{const i=async()=>{const i=t[e]??t[n];return"function"==typeof i?i():i};return"credentialScope"===e||"CredentialScope"===n?async()=>{const e="function"==typeof t.credentials?await t.credentials():t.credentials;return e?.credentialScope??e?.CredentialScope}:"accountId"===e||"AccountId"===n?async()=>{const e="function"==typeof t.credentials?await t.credentials():t.credentials;return e?.accountId??e?.AccountId}:"endpoint"===e||"endpoint"===n?async()=>{if(!1===t.isCustomEndpoint)return;const e=await i();if(e&&"object"==typeof e){if("url"in e)return e.url.href;if("hostname"in e){const{protocol:n,hostname:t,port:i,path:s}=e;return`${n}//${t}${i?":"+i:""}${s}`}}return e}:i},d=async e=>{},p=e=>"object"==typeof e?"url"in e?s(e.url):e:s(e),g=async(e,n,t)=>{const i={},s=n?.getEndpointParameterInstructions?.()||{};for(const[o,r]of Object.entries(s))switch(r.type){case"staticContextParams":i[o]=r.value;break;case"contextParams":i[o]=e[r.name];break;case"clientContextParams":case"builtInParams":i[o]=await c(r.name,o,t)();break;case"operationContextParams":i[o]=r.get(e);break;default:throw new Error("Unrecognized endpoint parameter instruction: "+JSON.stringify(r))}return 0===Object.keys(s).length&&Object.assign(i,t),"s3"===String(t.serviceId).toLowerCase()&&await(async e=>{const n=e?.Bucket||"";if("string"==typeof e.Bucket&&(e.Bucket=n.replace(/#/g,encodeURIComponent("#")).replace(/\?/g,encodeURIComponent("?"))),(e=>{const[n,t,i,,,s]=e.split(":"),o="arn"===n&&e.split(":").length>=6,r=Boolean(o&&t&&i&&s);if(o&&!r)throw new Error(`Invalid ARN: ${e} was an invalid ARN.`);return r})(n)){if(!0===e.ForcePathStyle)throw new Error("Path-style addressing cannot be used with ARN buckets")}else t=n,(!o.test(t)||r.test(t)||a.test(t)||-1!==n.indexOf(".")&&!String(e.Endpoint).startsWith("http:")||n.toLowerCase()!==n||n.length<3)&&(e.ForcePathStyle=!0);var t;return e.DisableMultiRegionAccessPoints&&(e.disableMultiRegionAccessPoints=!0,e.DisableMRAP=!0),e})(i),i},u={step:"serialize",tags:["ENDPOINT_PARAMETERS","ENDPOINT_V2","ENDPOINT"],name:"endpointV2Middleware",override:!0,relation:"before",toMiddleware:i.name},l=(t,i)=>({applyToStack:s=>{s.addRelativeTo((({config:t,instructions:i})=>(s,o)=>async r=>{t.isCustomEndpoint&&e(o,"ENDPOINT_OVERRIDE","N");const a=await(async(e,n,t,i)=>{if(!t.isCustomEndpoint){let e;e=t.serviceConfiguredEndpoint?await t.serviceConfiguredEndpoint():await d(t.serviceId),e&&(t.endpoint=()=>Promise.resolve(p(e)),t.isCustomEndpoint=!0)}const s=await g(e,n,t);if("function"!=typeof t.endpointProvider)throw new Error("config.endpointProvider is not set.");return t.endpointProvider(s,i)})(r.input,{getEndpointParameterInstructions:()=>i},{...t},o);o.endpointV2=a,o.authSchemes=a.properties?.authSchemes;const c=o.authSchemes?.[0];if(c){o.signing_region=c.signingRegion,o.signing_service=c.signingName;const e=n(o),t=e?.selectedHttpAuthScheme?.httpAuthOption;t&&(t.signingProperties=Object.assign(t.signingProperties||{},{signing_region:c.signingRegion,signingRegion:c.signingRegion,signing_service:c.signingName,signingName:c.signingName,signingRegionSet:c.signingRegionSet},c.properties))}return s({...r})})({config:t,instructions:i}),u)}}),m=e=>{const n=e.tls??!0,{endpoint:i,useDualstackEndpoint:s,useFipsEndpoint:o}=e,r=null!=i?async()=>p(await t(i)()):void 0,a=!!i,c=Object.assign(e,{endpoint:r,tls:n,isCustomEndpoint:a,useDualstackEndpoint:t(s??!1),useFipsEndpoint:t(o??!1)});let g;return c.serviceConfiguredEndpoint=async()=>(e.serviceId&&!g&&(g=d(e.serviceId)),g),c};export{m as a,l as g,g as r};
