const e=(e,r)=>{const o=[];if(e&&o.push(e),r)for(const n of r)o.push(n);return o},r=(e,r)=>`${e||"anonymous"}${r&&r.length>0?` (a.k.a. ${r.join(",")})`:""}`,o=()=>{let i=[],a=[],s=!1;const f=new Set,c=e=>(i.forEach(r=>{e.add(r.middleware,{...r})}),a.forEach(r=>{e.addRelativeTo(r.middleware,{...r})}),e.identifyOnResolve?.(u.identifyOnResolve()),e),d=e=>{const r=[];return e.before.forEach(e=>{0===e.before.length&&0===e.after.length?r.push(e):r.push(...d(e))}),r.push(e),e.after.reverse().forEach(e=>{0===e.before.length&&0===e.after.length?r.push(e):r.push(...d(e))}),r},l=(o=!1)=>{const s=[],f=[],c={};var l;return i.forEach(r=>{const o={...r,before:[],after:[]};for(const n of e(o.name,o.aliases))c[n]=o;s.push(o)}),a.forEach(r=>{const o={...r,before:[],after:[]};for(const n of e(o.name,o.aliases))c[n]=o;f.push(o)}),f.forEach(e=>{if(e.toMiddleware){const n=c[e.toMiddleware];if(void 0===n){if(o)return;throw new Error(`${e.toMiddleware} is not found when adding ${r(e.name,e.aliases)} middleware ${e.relation} ${e.toMiddleware}`)}"after"===e.relation&&n.after.push(e),"before"===e.relation&&n.before.push(e)}}),(l=s,l.sort((e,r)=>n[r.step]-n[e.step]||t[r.priority||"normal"]-t[e.priority||"normal"])).map(d).reduce((e,r)=>(e.push(...r),e),[])},u={add:(o,n={})=>{const{name:t,override:a,aliases:s}=n,c={step:"initialize",priority:"normal",middleware:o,...n},d=e(t,s);if(d.length>0){if(d.some(e=>f.has(e))){if(!a)throw new Error(`Duplicate middleware name '${r(t,s)}'`);for(const e of d){const o=i.findIndex(r=>r.name===e||r.aliases?.some(r=>r===e));if(-1===o)continue;const n=i[o];if(n.step!==c.step||c.priority!==n.priority)throw new Error(`"${r(n.name,n.aliases)}" middleware with ${n.priority} priority in ${n.step} step cannot be overridden by "${r(t,s)}" middleware with ${c.priority} priority in ${c.step} step.`);i.splice(o,1)}}for(const e of d)f.add(e)}i.push(c)},addRelativeTo:(o,n)=>{const{name:t,override:i,aliases:s}=n,c={middleware:o,...n},d=e(t,s);if(d.length>0){if(d.some(e=>f.has(e))){if(!i)throw new Error(`Duplicate middleware name '${r(t,s)}'`);for(const e of d){const o=a.findIndex(r=>r.name===e||r.aliases?.some(r=>r===e));if(-1===o)continue;const n=a[o];if(n.toMiddleware!==c.toMiddleware||n.relation!==c.relation)throw new Error(`"${r(n.name,n.aliases)}" middleware ${n.relation} "${n.toMiddleware}" middleware cannot be overridden by "${r(t,s)}" middleware ${c.relation} "${c.toMiddleware}" middleware.`);a.splice(o,1)}}for(const e of d)f.add(e)}a.push(c)},clone:()=>c(o()),use:e=>{e.applyToStack(u)},remove:r=>"string"==typeof r?(r=>{let o=!1;const n=n=>{const t=e(n.name,n.aliases);if(t.includes(r)){o=!0;for(const e of t)f.delete(e);return!1}return!0};return i=i.filter(n),a=a.filter(n),o})(r):(r=>{let o=!1;const n=n=>{if(n.middleware===r){o=!0;for(const r of e(n.name,n.aliases))f.delete(r);return!1}return!0};return i=i.filter(n),a=a.filter(n),o})(r),removeByTag:r=>{let o=!1;const n=n=>{const{tags:t,name:i,aliases:a}=n;if(t&&t.includes(r)){const r=e(i,a);for(const e of r)f.delete(e);return o=!0,!1}return!0};return i=i.filter(n),a=a.filter(n),o},concat:e=>{const r=c(o());return r.use(e),r.identifyOnResolve(s||r.identifyOnResolve()||(e.identifyOnResolve?.()??!1)),r},applyToStack:c,identify:()=>l(!0).map(e=>{const o=e.step??e.relation+" "+e.toMiddleware;return r(e.name,e.aliases)+" - "+o}),identifyOnResolve:e=>("boolean"==typeof e&&(s=e),s),resolve:(e,r)=>{for(const o of l().map(e=>e.middleware).reverse())e=o(e,r);return e}};return u},n={initialize:5,serialize:4,build:3,finalizeRequest:2,deserialize:1},t={high:3,normal:2,low:1};export{o as c};
