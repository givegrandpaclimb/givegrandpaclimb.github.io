import{P as e,E as t,g as r,j as n}from"./vendor-codemirror-state-D88w-V9V.js";import{k as o}from"./vendor-codemirror-view-DVzN21hM.js";import{c as s,p as i,o as l,q as u,s as a,i as f,f as c,d as m,r as d,t as g,P as p}from"./vendor-codemirror-language-C3hkV707.js";import{C as h}from"./vendor-codemirror-autocomplete-BSg-hdYo.js";import{M as k,p as v,a as L,G as j,S as w,b as B,E as b}from"./vendor-lezer-markdown-B-1aw399.js";import{html as I,htmlCompletionSource as S}from"./vendor-codemirror-lang-html-CrkYb4od.js";import{N as O}from"./vendor-lezer-common-QPiu6Hcj.js";import"./vendor-marijn-find-cluster-break-BFVNO93u.js";import"./vendor-style-mod-tLAqh-pC.js";import"./vendor-w3c-keyname-BorKtCV5.js";import"./vendor-lezer-highlight-4-fykoed.js";import"./vendor-lezer-html-tLnryuX4.js";import"./vendor-lezer-lr-CZr-wB1l.js";import"./vendor-codemirror-lang-css-C8Vb684c.js";import"./vendor-lezer-css-zR3a2mIT.js";import"./vendor-codemirror-lang-javascript-GVwct36_.js";import"./vendor-lezer-javascript-DQFFX--0.js";const T=l({commentTokens:{block:{open:"\x3c!--",close:"--\x3e"}}}),x=new O,z=L.configure({props:[c.add(e=>!e.is("Block")||e.is("Document")||null!=C(e)||function(e){return"OrderedList"==e.name||"BulletList"==e.name}(e)?void 0:(e,t)=>({from:t.doc.lineAt(e.from).to,to:e.to})),x.add(C),m.add({Document:()=>null}),d.add({Document:T})]});function C(e){let t=/^(?:ATX|Setext)Heading(\d)$/.exec(e.name);return t?+t[1]:void 0}function y(e,t){let r=e;for(;;){let e,n=r.nextSibling;if(!n||null!=(e=C(n.type))&&e<=t)break;r=n}return r.to}const E=u.of((e,t,r)=>{for(let n=a(e).resolveInner(r,-1);n&&!(n.from<t);n=n.parent){let e=n.type.prop(x);if(null==e)continue;let t=y(n,e);if(t>r)return{from:r,to:t}}return null});function $(e){return new i(T,e,[E],"markdown")}const q=$(z),M=$(z.configure([j,w,B,b,{props:[c.add({Table:(e,t)=>({from:t.doc.lineAt(e.from).to,to:e.to})})]}]));class P{constructor(e,t,r,n,o,s,i){this.node=e,this.from=t,this.to=r,this.spaceBefore=n,this.spaceAfter=o,this.type=s,this.item=i}blank(e,t=!0){let r=this.spaceBefore+("Blockquote"==this.node.name?">":"");if(null!=e){for(;r.length<e;)r+=" ";return r}for(let n=this.to-this.from-r.length-this.spaceAfter.length;n>0;n--)r+=" ";return r+(t?this.spaceAfter:"")}marker(e,t){let r="OrderedList"==this.node.name?String(+F(this.item,e)[2]+t):"";return this.spaceBefore+r+this.type+this.spaceAfter}}function D(e,t){let r=[],n=[];for(let o=e;o;o=o.parent){if("FencedCode"==o.name)return n;"ListItem"!=o.name&&"Blockquote"!=o.name||r.push(o)}for(let o=r.length-1;o>=0;o--){let e,s=r[o],i=t.lineAt(s.from),l=s.from-i.from;if("Blockquote"==s.name&&(e=/^ *>( ?)/.exec(i.text.slice(l))))n.push(new P(s,l,l+e[0].length,"",e[1],">",null));else if("ListItem"==s.name&&"OrderedList"==s.parent.name&&(e=/^( *)\d+([.)])( *)/.exec(i.text.slice(l)))){let t=e[3],r=e[0].length;t.length>=4&&(t=t.slice(0,t.length-4),r-=4),n.push(new P(s.parent,l,l+r,e[1],t,e[2],s))}else if("ListItem"==s.name&&"BulletList"==s.parent.name&&(e=/^( *)([-+*])( {1,4}\[[ xX]\])?( +)/.exec(i.text.slice(l)))){let t=e[4],r=e[0].length;t.length>4&&(t=t.slice(0,t.length-4),r-=4);let o=e[2];e[3]&&(o+=e[3].replace(/[xX]/," ")),n.push(new P(s.parent,l,l+r,e[1],t,o,s))}}return n}function F(e,t){return/^(\s*)(\d+)(?=[.)])/.exec(t.sliceString(e.from,e.from+10))}function V(e,t,r,n=0){for(let o=-1,s=e;;){if("ListItem"==s.name){let e=F(s,t),i=+e[2];if(o>=0){if(i!=o+1)return;r.push({from:s.from+e[1].length,to:s.from+e[0].length,insert:String(o+2+n)})}o=i}let e=s.nextSibling;if(!e)break;s=e}}function X(e,t){let n=/^[ \t]*/.exec(e)[0].length;if(!n||"\t"!=t.facet(f))return e;let o="";for(let s=r(e,4,n);s>0;)s>=4?(o+="\t",s-=4):(o+=" ",s--);return o+e.slice(n)}const H=({state:e,dispatch:n})=>{let o=a(e),{doc:s}=e,i=null,l=e.changeByRange(n=>{if(!n.empty||!M.isActiveAt(e,n.from,-1)&&!M.isActiveAt(e,n.from,1))return i={range:n};let l=n.from,u=s.lineAt(l),a=D(o.resolveInner(l,-1),s);for(;a.length&&a[a.length-1].from>l-u.from;)a.pop();if(!a.length)return i={range:n};let f=a[a.length-1];if(f.to-f.spaceAfter.length>l-u.from)return i={range:n};let c=l>=f.to-f.spaceAfter.length&&!/\S/.test(u.text.slice(f.to));if(f.item&&c){let r=f.node.firstChild,n=f.node.getChild("ListItem","ListItem");if(r.to>=l||n&&n.to<l||u.from>0&&!/[^\s>]/.test(s.lineAt(u.from-1).text)){let e,r=a.length>1?a[a.length-2]:null,n="";r&&r.item?(e=u.from+r.from,n=r.marker(s,1)):e=u.from+(r?r.to:0);let o=[{from:e,to:l,insert:n}];return"OrderedList"==f.node.name&&V(f.item,s,o,-2),r&&"OrderedList"==r.node.name&&V(r.item,s,o),{range:t.cursor(e+n.length),changes:o}}{let r=G(a,e,u);return{range:t.cursor(l+r.length+1),changes:{from:u.from,insert:r+e.lineBreak}}}}if("Blockquote"==f.node.name&&c&&u.from){let t=s.lineAt(u.from-1),r=/>\s*$/.exec(t.text);if(r&&r.index==f.from){let o=e.changes([{from:t.from+r.index,to:t.to},{from:u.from+f.from,to:u.to}]);return{range:n.map(o),changes:o}}}let m=[];"OrderedList"==f.node.name&&V(f.item,s,m);let d=f.item&&f.item.from<u.from,g="";if(!d||/^[\s\d.)\-+*>]*/.exec(u.text)[0].length>=f.to)for(let e=0,t=a.length-1;e<=t;e++)g+=e!=t||d?a[e].blank(e<t?r(u.text,4,a[e+1].from)-g.length:null):a[e].marker(s,1);let p=l;for(;p>u.from&&/\s/.test(u.text.charAt(p-u.from-1));)p--;return g=X(g,e),function(e,t){if("OrderedList"!=e.name&&"BulletList"!=e.name)return!1;let r=e.firstChild,n=e.getChild("ListItem","ListItem");if(!n)return!1;let o=t.lineAt(r.to),s=t.lineAt(n.from),i=/^[\s>]*$/.test(o.text);return o.number+(i?0:1)<s.number}(f.node,e.doc)&&(g=G(a,e,u)+e.lineBreak+g),m.push({from:p,to:l,insert:e.lineBreak+g}),{range:t.cursor(p+g.length+1),changes:m}});return!i&&(n(e.update(l,{scrollIntoView:!0,userEvent:"input"})),!0)};function A(e){return"QuoteMark"==e.name||"ListMark"==e.name}function G(e,t,n){let o="";for(let s=0,i=e.length-2;s<=i;s++)o+=e[s].blank(s<i?r(n.text,4,e[s+1].from)-o.length:null,s<i);return X(o,t)}const K=({state:e,dispatch:n})=>{let o=a(e),s=null,i=e.changeByRange(n=>{let i=n.from,{doc:l}=e;if(n.empty&&M.isActiveAt(e,n.from)){let n=l.lineAt(i),s=D(function(e,t){let r=e.resolveInner(t,-1),n=t;A(r)&&(n=r.from,r=r.parent);for(let o;o=r.childBefore(n);)if(A(o))n=o.from;else{if("OrderedList"!=o.name&&"BulletList"!=o.name)break;r=o.lastChild,n=r.to}return r}(o,i),l);if(s.length){let o=s[s.length-1],l=o.to-o.spaceAfter.length+(o.spaceAfter?1:0);if(i-n.from>l&&!/\S/.test(n.text.slice(l,i-n.from)))return{range:t.cursor(n.from+l),changes:{from:n.from+l,to:i}};if(i-n.from==l&&(!o.item||n.from<=o.item.from||!/\S/.test(n.text.slice(0,o.to)))){let s=n.from+o.from;if(o.item&&o.node.from<o.item.from&&/\S/.test(n.text.slice(o.from,o.to))){let i=o.blank(r(n.text,4,o.to)-r(n.text,4,o.from));return s==n.from&&(i=X(i,e)),{range:t.cursor(s+i.length),changes:{from:s,to:n.from+o.to,insert:i}}}if(s<i)return{range:t.cursor(s),changes:{from:s,to:i}}}}}return s={range:n}});return!s&&(n(e.update(i,{scrollIntoView:!0,userEvent:"delete"})),!0)},N=[{key:"Enter",run:H},{key:"Backspace",run:K}],Q=I({matchClosingTags:!1});function R(t={}){let{codeLanguages:r,defaultCodeLanguage:n,addKeymap:i=!0,base:{parser:l}=q,completeHTMLTags:u=!0,htmlTagLanguage:a=Q}=t;if(!(l instanceof k))throw new RangeError("Base parser provided to `markdown` should be a Markdown parser");let f,c=t.extensions?[t.extensions]:[],m=[a.support];n instanceof s?(m.push(n.support),f=n.language):n&&(f=n);let d=r||f?(h=r,L=f,e=>{if(e&&h){let t=null;if(e=/\S*/.exec(e)[0],t="function"==typeof h?h(e):g.matchLanguageName(h,e,!0),t instanceof g)return t.support?t.support.language.parser:p.getSkippingParser(t.load());if(t)return t.parser}return L?L.parser:null}):void 0;var h,L;c.push(v({codeParser:d,htmlParser:a.language.parser})),i&&m.push(e.high(o.of(N)));let j=$(l.configure(c));return u&&m.push(j.data.of({autocomplete:U})),new s(j,m)}function U(e){let{state:t,pos:r}=e,n=/<[:\-\.\w\u00b7-\uffff]*$/.exec(t.sliceDoc(r-25,r));if(!n)return null;let o=a(t).resolveInner(r,-1);for(;o&&!o.type.isTop;){if("CodeBlock"==o.name||"FencedCode"==o.name||"ProcessingInstructionBlock"==o.name||"CommentBlock"==o.name||"Link"==o.name||"Image"==o.name)return null;o=o.parent}return{from:r-n[0].length,to:r,options:Y(),validFor:/^<[:\-\.\w\u00b7-\uffff]*$/}}let W=null;function Y(){if(W)return W;let e=S(new h(n.create({extensions:Q}),0,!0));return W=e?e.options:[]}export{q as commonmarkLanguage,K as deleteMarkupBackward,H as insertNewlineContinueMarkup,R as markdown,N as markdownKeymap,M as markdownLanguage};
